---
# Deploy nodes playbook: Deploy and manage Lean nodes
# Requires node_names to be specified (comma or space separated)
# This playbook runs on localhost to parse node names, then deploys to remote hosts
#
# Before deployment, it syncs essential config files from local to remote:
#   - validator-config.yaml
#   - node key files (*.key)
#   - config.yaml, validators.yaml, nodes.yaml
#   - genesis.ssz, genesis.json
#   - hash-sig-keys/ directory (if exists, for qlean nodes)

- name: Parse and validate node names
  hosts: localhost
  connection: local
  gather_facts: yes
  vars:
    validator_config_file: "{{ genesis_dir }}/validator-config.yaml"

  tasks:
    - name: Validate validator-config.yaml exists
      stat:
        path: "{{ validator_config_file }}"
      register: validator_config_stat

    - name: Fail if validator-config.yaml missing
      fail:
        msg: "validator-config.yaml not found at {{ validator_config_file }}"
      when: not validator_config_stat.stat.exists

    - name: Extract all node names
      shell: |
        yq eval '.validators[].name' {{ validator_config_file }}
      register: all_node_names_raw
      changed_when: false

    - name: Set all node names
      set_fact:
        all_node_names: "{{ all_node_names_raw.stdout_lines }}"

    - name: Fail if node_names is not specified
      fail:
        msg: "node_names must be specified. Provide one or more node names (comma or space separated)."
      when: node_names is not defined or node_names == ""

    - name: Handle "all" node names - expand to all nodes
      set_fact:
        deploy_nodes: "{{ all_node_names }}"
      when:
        - node_names is defined
        - node_names == "all"

    - name: Parse node names if provided as comma-separated string
      set_fact:
        deploy_nodes: "{{ node_names.split(',') | map('trim') | list }}"
      when: 
        - node_names is defined
        - node_names is string
        - node_names != "all"
        - '("," in node_names)'

    - name: Parse node names if provided as space-separated string
      set_fact:
        deploy_nodes: "{{ node_names.split(' ') | map('trim') | select('length') | list }}"
      when: 
        - node_names is defined
        - node_names is string
        - node_names != "all"
        - '("," not in node_names)'
        - '(" " in node_names)'

    - name: Handle single node name
      set_fact:
        deploy_nodes: "{{ [node_names] }}"
      when:
        - node_names is defined
        - node_names is string
        - node_names != "all"
        - '"," not in node_names'
        - '" " not in node_names'

    - name: Display deployment targets
      debug:
        msg: "Deploying nodes: {{ deploy_nodes | join(', ') }}"

    - name: Add deployment hosts to inventory
      add_host:
        name: "{{ item }}"
        groups: deployment_targets
      loop: "{{ deploy_nodes }}"

    - name: Store local genesis dir for remote plays
      set_fact:
        local_genesis_dir_path: "{{ genesis_dir }}"
        cacheable: yes

- name: Deploy nodes on remote hosts
  hosts: deployment_targets
  gather_facts: yes
  vars:
    # Use remote paths on remote hosts
    genesis_dir: "{{ remote_genesis_dir | default('/opt/lean-quickstart/genesis') }}"
    data_dir: "{{ remote_data_dir | default('/opt/lean-quickstart/data') }}"
    validator_config_file: "{{ genesis_dir }}/validator-config.yaml"
    # node_name is set to inventory_hostname (which matches the node name)
    node_name: "{{ inventory_hostname }}"
    # Local genesis directory for syncing config files (from localhost play)
    local_genesis_dir: "{{ hostvars['localhost']['local_genesis_dir_path'] }}"

  tasks:
    - name: Create remote genesis directory
      file:
        path: "{{ genesis_dir }}"
        state: directory
        mode: '0755'
      tags:
        - deploy
        - sync

    - name: Sync validator-config.yaml to remote host
      copy:
        src: "{{ local_genesis_dir }}/validator-config.yaml"
        dest: "{{ genesis_dir }}/validator-config.yaml"
        mode: '0644'
        force: yes
      tags:
        - deploy
        - sync

    - name: Sync node key file to remote host
      copy:
        src: "{{ local_genesis_dir }}/{{ node_name }}.key"
        dest: "{{ genesis_dir }}/{{ node_name }}.key"
        mode: '0600'
        force: yes
      tags:
        - deploy
        - sync

    - name: Sync essential genesis config files
      copy:
        src: "{{ local_genesis_dir }}/{{ item }}"
        dest: "{{ genesis_dir }}/{{ item }}"
        mode: '0644'
        force: yes
      loop:
        - config.yaml
        - validators.yaml
        - nodes.yaml
        - genesis.ssz
        - genesis.json
      tags:
        - deploy
        - sync

    - name: Check if hash-sig-keys directory exists locally
      stat:
        path: "{{ local_genesis_dir }}/hash-sig-keys"
      register: hash_sig_keys_local
      delegate_to: localhost
      tags:
        - deploy
        - sync

    - name: Create hash-sig-keys directory on remote
      file:
        path: "{{ genesis_dir }}/hash-sig-keys"
        state: directory
        mode: '0755'
      when: hash_sig_keys_local.stat.exists
      tags:
        - deploy
        - sync

    - name: Sync hash-sig-keys directory (for qlean nodes)
      copy:
        src: "{{ local_genesis_dir }}/hash-sig-keys/"
        dest: "{{ genesis_dir }}/hash-sig-keys/"
        mode: '0644'
        force: yes
      when: hash_sig_keys_local.stat.exists
      tags:
        - deploy
        - sync

    - name: Clean node data directory
      raw: rm -rf {{ data_dir }}/{{ node_name }}
      when:
        - clean_data | default(false) | bool
        - not (skip_role_cleaning | default(false) | bool)
      tags:
        - zeam
        - ream
        - qlean
        - lantern
        - lighthouse
        - grandine
        - ethlambda
        - deploy

    - name: Include common role
      include_role:
        name: common
      vars:
        node_names: "{{ [inventory_hostname] }}"
      tags:
        - setup
        - deploy

    - name: Deploy this node
      include_tasks: helpers/deploy-single-node.yml
      vars:
        node_name: "{{ inventory_hostname }}"
      tags:
        - deploy

